- name: predeploy docker compose
  hosts: test_sf
  vars:
    - dev_path: /usr/data
  gather_facts: false
  become: true
  become_user: "root"
  become_method: "sudo"
  
  tasks:

    - name: creating data directory
      file:
        path: /usr/data
        state: directory
        owner: root
        group: root
        mode: "u=rw,g=rw,o=r"
        recurse: true
  
    - name: create needed content directories
      file:
        path: "{{ dev_path }}/{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "u=rwx,g=rwx,o=x"
      with_items:
        - www
        - nginx_conf
        - pg_data

    - name: copy nginx default.conf
      copy:
        src: "../docker_config/nginx/default.conf"
        dest: "{{ dev_path }}/nginx_conf/"
        owner: root
        group: root
        mode: "0664"
      tags:
        - conf_nginx

    - name: copy django folder
      copy:
        src: "../docker_config/django"
        dest: "{{ dev_path }}/"

    - name: download django app archive from github
      get_url:
        url: "https://github.com/The-Conference/findconf/archive/refs/heads/backend.zip"
        dest: "/root"
      tags:
        - conf_back

    - name: unzip django app
      unarchive:
        src: "/root/findconf-backend.zip"
        dest: "/root"
        remote_src: true
      tags:
        - conf_back

    - name: copy django app to data dir
      copy:
        src: "/root/findconf-backend/"
        dest: "{{ dev_path }}/django/app"
        remote_src: true
      tags:
        - conf_back

    - name: add unicorn to django requirements
      lineinfile:
        path: "{{ dev_path }}/django/app/requirements.txt"
        line: "gunicorn==20.0.4"
      tags:
        - conf_back

    - name: remove temp files from /root
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - "/root/findconf-backend.zip"
        - "/root/findconf-backend"
      tags:
        - conf_back
    
    - name: copy docker-compose.yml
      copy:
        src: "../docker_config/docker-compose.yml"
        dest: "{{ dev_path }}/"

    - name: copy env. file
      copy:
        src: "../.metadata/.docker_env"
        dest: "/root/"